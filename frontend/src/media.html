<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  
  <!-- API Configuration Meta Tags -->
  <meta name="api-base-url" content="">
  <meta name="use-mock-market" content="true">
  <meta name="use-mock-signals" content="true">
  <meta name="use-mock-journal" content="true">
  <meta name="use-mock-media" content="true">
  
  <title>Public Media - OmniBoard</title>
  <meta name="description" content="Track cryptocurrency mentions and sentiment across social media and news sources"/>
  
  <!-- Tabler Core CSS -->
  <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
  <link href="https://unpkg.com/@tabler/icons@latest/dist/tabler-icons.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="/css/omniboard.css" rel="stylesheet">
</head>
<body>
  <div class="page">
    <!-- Sidebar -->
    <aside class="navbar navbar-vertical navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <button class="navbar-toggler" type="button">
          <span class="navbar-toggler-icon"></span>
        </button>
        <h1 class="navbar-brand navbar-brand-autodark">
          <a href="/index.html">
            OmniBoard
          </a>
        </h1>
        <div class="navbar-nav flex-row d-lg-none">
          <div class="nav-item dropdown">
            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
              <span class="avatar avatar-sm" style="background-image: url(./static/avatars/000m.jpg)"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
              <a href="#" class="dropdown-item">Settings</a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">Logout</a>
            </div>
          </div>
        </div>
        <div class="collapse navbar-collapse" id="sidebar-menu">
          <ul class="navbar-nav pt-lg-3">
            <li class="nav-item">
              <a class="nav-link" href="/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-chart-line"></i>
                </span>
                <span class="nav-link-title">Market Overview</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/signals/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-signal"></i>
                </span>
                <span class="nav-link-title">Crypto Signals</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/journal/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-book"></i>
                </span>
                <span class="nav-link-title">Trading Journal</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/media/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-device-tv"></i>
                </span>
                <span class="nav-link-title">Public Media</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </aside>
    
    <!-- Topbar -->
    <div class="page-wrapper">
      <header class="navbar navbar-expand-md navbar-light d-none d-lg-flex d-print-none">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-nav flex-row order-md-last">
            <div class="nav-item dropdown">
              <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                <span class="avatar avatar-sm" style="background-image: url(./static/avatars/000m.jpg)"></span>
                <div class="d-none d-xl-block ps-2">
                  <div>Admin</div>
                  <div class="mt-1 small text-muted">Administrator</div>
                </div>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                <a href="#" class="dropdown-item">Settings</a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">Logout</a>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Page Content -->
      <div class="page-body">
        <div class="container-xl">
          <div class="page-header d-print-none">
            <div class="container-xl">
              <div class="row g-2 align-items-center">
                <div class="col">
                  <h2 class="page-title">
                    Public Media
                  </h2>
                  <div class="text-muted mt-1">Track cryptocurrency mentions and sentiment across social media and news</div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                  <div class="btn-list">
                    <button class="btn btn-primary" onclick="loadMediaData()">
                      <i class="ti ti-refresh me-1"></i>
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Main Content - Feed -->
            <div class="col-lg-8">
              <!-- Filters -->
              <div class="card mb-4">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Time Range</label>
                      <select class="form-select" id="time-range">
                        <option value="1h">Last hour</option>
                        <option value="6h">Last 6 hours</option>
                        <option value="24h" selected>Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Source</label>
                      <select class="form-select" id="source-filter">
                        <option value="all">All sources</option>
                        <option value="twitter">Twitter</option>
                        <option value="telegram">Telegram</option>
                        <option value="reddit">Reddit</option>
                        <option value="news">News</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Sentiment</label>
                      <select class="form-select" id="sentiment-filter">
                        <option value="all">All sentiments</option>
                        <option value="bullish">Bullish</option>
                        <option value="bearish">Bearish</option>
                        <option value="neutral">Neutral</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Feed List -->
              <div class="card" id="feed-card">
                <div class="card-header">
                  <h3 class="card-title">Media Feed</h3>
                  <div class="card-actions">
                    <span class="badge bg-primary" id="feed-count">0</span>
                  </div>
                </div>
                <div class="card-body" id="feed-list">
                  <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2 text-muted">Loading media feed...</div>
                  </div>
                </div>
              </div>

              <!-- No Feed State -->
              <div class="card d-none" id="no-feed">
                <div class="card-body text-center py-5">
                  <div class="text-muted">
                    <i class="ti ti-device-tv-off ti-3x mb-3"></i>
                    <h3>No media content available</h3>
                    <p>Try adjusting your filters or check back later.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sidebar - Heatmap -->
            <div class="col-lg-4">
              <div class="card" id="heatmap-card">
                <div class="card-header">
                  <h3 class="card-title">Top Coin Mentions</h3>
                  <div class="card-actions">
                    <span class="badge bg-primary" id="heatmap-count">0</span>
                  </div>
                </div>
                <div class="card-body" id="heatmap-list">
                  <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2 text-muted small">Loading heatmap...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <footer class="footer footer-transparent d-print-none">
        <div class="container-xl">
          <div class="row text-center align-items-center flex-row-reverse">
            <div class="col-12 col-lg-auto mt-3 mt-lg-0">
              <ul class="list-inline list-inline-dots mb-0">
                <li class="list-inline-item">
                  Copyright &copy; 2024
                  <a href="." class="link-secondary">OmniBoard</a>.
                  All rights reserved.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  
  <!-- Tabler Core JS -->
  <script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js" defer></script>
  
  <!-- OmniBoard Scripts -->
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/components.js"></script>
  
  <script>
  // Public Media Page Logic
  class PublicMediaPage {
    constructor() {
      this.feed = [];
      this.heatmap = [];
      this.filteredFeed = [];
      this.refreshInterval = null;
      this.init();
    }

    init() {
      this.loadMediaData();
      this.setupFilters();
      this.startAutoRefresh();
    }

    // Загрузить данные медиа
    async loadMediaData() {
      try {
        const timeRange = document.getElementById('time-range')?.value || '24h';
        
        // Загрузить ленту
        const feedData = await window.omniboardAPI.getInfluencersFeed(timeRange);
        this.feed = feedData;
        
        // Загрузить heatmap
        const heatmapData = await window.omniboardAPI.getInfluencersHeatmap(timeRange);
        this.heatmap = heatmapData;
        
        this.applyFilters();
      } catch (error) {
        console.error('Failed to load media data:', error);
        this.showError('Failed to load media data');
      }
    }

    // Настроить фильтры
    setupFilters() {
      const timeRangeFilter = document.getElementById('time-range');
      const sourceFilter = document.getElementById('source-filter');
      const sentimentFilter = document.getElementById('sentiment-filter');

      if (timeRangeFilter) {
        timeRangeFilter.addEventListener('change', () => this.loadMediaData());
      }
      if (sourceFilter) {
        sourceFilter.addEventListener('change', () => this.applyFilters());
      }
      if (sentimentFilter) {
        sentimentFilter.addEventListener('change', () => this.applyFilters());
      }
    }

    // Применить фильтры
    applyFilters() {
      const sourceFilter = document.getElementById('source-filter')?.value || 'all';
      const sentimentFilter = document.getElementById('sentiment-filter')?.value || 'all';
      
      this.filteredFeed = this.feed.filter(item => {
        const sourceMatch = sourceFilter === 'all' || item.source === sourceFilter;
        const sentimentMatch = sentimentFilter === 'all' || item.sentiment === sentimentFilter;
        return sourceMatch && sentimentMatch;
      });

      this.renderFeed();
      this.renderHeatmap();
    }

    // Отобразить ленту
    renderFeed() {
      const feedList = document.getElementById('feed-list');
      const noFeed = document.getElementById('no-feed');
      const feedCount = document.getElementById('feed-count');
      
      if (!feedList) return;

      if (!this.filteredFeed || this.filteredFeed.length === 0) {
        feedList.classList.add('d-none');
        if (noFeed) noFeed.classList.remove('d-none');
        if (feedCount) feedCount.textContent = '0';
        return;
      }

      if (noFeed) noFeed.classList.add('d-none');
      feedList.classList.remove('d-none');
      if (feedCount) feedCount.textContent = this.filteredFeed.length;

      feedList.innerHTML = this.filteredFeed.map(item => this.createFeedItem(item)).join('');
    }

    // Создать элемент ленты
    createFeedItem(item) {
      const sourceIcon = item.source === 'twitter' ? 'ti-brand-twitter' : 
                        item.source === 'telegram' ? 'ti-brand-telegram' : 
                        item.source === 'reddit' ? 'ti-brand-reddit' : 'ti-news';
      
      const sentimentClass = item.sentiment === 'bullish' ? 'bullish' : 
                            item.sentiment === 'bearish' ? 'bearish' : 'neutral';
      
      const symbolsHtml = item.symbols.map(symbol => 
        `<span class="badge bg-secondary me-1">${symbol}</span>`
      ).join('');

      return `
        <div class="feed-item ${sentimentClass} mb-4">
          <div class="d-flex align-items-start">
            <div class="flex-shrink-0">
              <span class="avatar avatar-sm bg-${item.source === 'twitter' ? 'blue' : 
                                                 item.source === 'telegram' ? 'cyan' : 
                                                 item.source === 'reddit' ? 'orange' : 'gray'} text-white">
                <i class="ti ${sourceIcon}"></i>
              </span>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="feed-source">
                ${item.handle}
              </div>
              <div class="feed-text text-truncate-2">
                ${item.text}
              </div>
              <div class="feed-meta d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  ${symbolsHtml}
                  <span class="badge bg-${item.sentiment === 'bullish' ? 'success' : 
                                         item.sentiment === 'bearish' ? 'danger' : 'secondary'} ms-2">
                    ${item.sentiment}
                  </span>
                </div>
                <div class="text-muted small">
                  ${window.omniboardComponents.formatTime(item.timestamp)}
                </div>
              </div>
              <div class="mt-2">
                <a href="#" class="btn btn-sm btn-outline-primary">
                  <i class="ti ti-external-link me-1"></i>
                  Open
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Отобразить heatmap
    renderHeatmap() {
      const heatmapList = document.getElementById('heatmap-list');
      const heatmapCount = document.getElementById('heatmap-count');
      
      if (!heatmapList) return;

      if (!this.heatmap || this.heatmap.length === 0) {
        heatmapList.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="ti ti-chart-bar-off ti-2x mb-2"></i>
            <div>No heatmap data</div>
          </div>
        `;
        if (heatmapCount) heatmapCount.textContent = '0';
        return;
      }

      if (heatmapCount) heatmapCount.textContent = this.heatmap.length;

      heatmapList.innerHTML = this.heatmap.map(item => `
        <div class="heatmap-item">
          <div class="d-flex align-items-center">
            <span class="avatar avatar-xs me-2">${item.symbol}</span>
            <div class="coin-symbol">${item.symbol}</div>
          </div>
          <div class="d-flex align-items-center">
            <span class="mentions-count me-2">${item.mentions}</span>
            <span class="badge bg-${item.sentiment === 'bullish' ? 'success' : 
                                   item.sentiment === 'bearish' ? 'danger' : 'secondary'}">
              ${item.sentiment}
            </span>
          </div>
        </div>
      `).join('');
    }

    // Начать автообновление
    startAutoRefresh() {
      const config = window.OMNIBOARD_CONFIG;
      
      // Обновление медиа каждые 5 минут
      this.refreshInterval = setInterval(() => {
        this.loadMediaData();
      }, (config.REFRESH_INTERVALS.MEDIA || 300) * 1000);
    }

    // Остановить автообновление
    stopAutoRefresh() {
      if (this.refreshInterval) {
        clearInterval(this.refreshInterval);
      }
    }

    // Показать ошибку
    showError(message) {
      window.omniboardComponents.showAlert(message, 'danger');
    }
  }

  // Глобальная функция для кнопки обновления
  function loadMediaData() {
    if (window.publicMediaPage) {
      window.publicMediaPage.loadMediaData();
    }
  }

  // Инициализация страницы
  document.addEventListener('DOMContentLoaded', function() {
    window.publicMediaPage = new PublicMediaPage();
  });

  // Очистка при уходе со страницы
  window.addEventListener('beforeunload', function() {
    if (window.publicMediaPage) {
      window.publicMediaPage.stopAutoRefresh();
    }
  });
  </script>
</body>
</html>
