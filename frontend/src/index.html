<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  
  <!-- API Configuration Meta Tags -->
  <meta name="api-base-url" content="">
  <meta name="use-mock-market" content="true">
  <meta name="use-mock-signals" content="true">
  <meta name="use-mock-journal" content="true">
  <meta name="use-mock-media" content="true">
  
  <title>Market Overview - OmniBoard</title>
  <meta name="description" content="Real-time cryptocurrency market overview with key metrics and ticker data"/>
  
  <!-- Tabler Core CSS -->
  <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
  <link href="https://unpkg.com/@tabler/icons@latest/dist/tabler-icons.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="/css/omniboard.css" rel="stylesheet">
</head>
<body class="theme-dark">
  <div class="page">
    <!-- Sidebar -->
    <aside class="navbar navbar-vertical navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <button class="navbar-toggler" type="button">
          <span class="navbar-toggler-icon"></span>
        </button>
        <h1 class="navbar-brand navbar-brand-autodark">
          <a href="/index.html">
            OmniBoard
          </a>
        </h1>
        <div class="navbar-nav flex-row d-lg-none">
                      <div class="nav-item dropdown">
              <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                <span class="avatar avatar-sm bg-primary">
                  <i class="ti ti-user"></i>
                </span>
              </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
              <a href="#" class="dropdown-item">Settings</a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">Logout</a>
            </div>
          </div>
        </div>
        <div class="collapse navbar-collapse" id="sidebar-menu">
          <ul class="navbar-nav pt-lg-3">
            <li class="nav-item">
              <a class="nav-link active" href="/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-chart-line"></i>
                </span>
                <span class="nav-link-title">Market Overview</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/signals/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-signal"></i>
                </span>
                <span class="nav-link-title">Crypto Signals</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/journal/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-book"></i>
                </span>
                <span class="nav-link-title">Trading Journal</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/media/index.html">
                <span class="nav-link-icon">
                  <i class="ti ti-device-tv"></i>
                </span>
                <span class="nav-link-title">Public Media</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </aside>
    
    <!-- Topbar -->
    <div class="page-wrapper">
      <header class="navbar navbar-expand-md navbar-light d-print-none">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-nav flex-row order-md-last">
            <div class="nav-item">
              <button class="btn btn-icon btn-link" id="theme-toggle" title="Toggle theme">
                <i class="ti ti-moon" id="theme-icon"></i>
              </button>
            </div>
            <div class="nav-item dropdown">
              <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                <span class="avatar avatar-sm bg-primary">
                  <i class="ti ti-user"></i>
                </span>
                <div class="d-none d-xl-block ps-2">
                  <div>Admin</div>
                  <div class="mt-1 small text-muted">Administrator</div>
                </div>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                <a href="#" class="dropdown-item">Settings</a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">Logout</a>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Page Content -->
      <div class="page-body">
        <div class="container-xl">
          <div class="page-header d-print-none">
            <div class="container-xl">
              <div class="row g-2 align-items-center">
                <div class="col">
                  <h2 class="page-title">
                    Market Overview
                  </h2>
                  <div class="text-muted mt-1">Real-time cryptocurrency market data and analysis</div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                  <div class="btn-list">
                    <button class="btn btn-primary" onclick="loadMarketData()">
                      <i class="ti ti-refresh me-1"></i>
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- KPI Cards -->
          <div class="row row-deck row-cards mb-4" id="kpi-cards">
            <div class="col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span class="bg-primary text-white avatar">
                        <i class="ti ti-chart-line"></i>
                      </span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">
                        Market Cap
                      </div>
                      <div class="text-muted" id="market-cap">
                        Loading...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span class="bg-green text-white avatar">
                        <i class="ti ti-activity"></i>
                      </span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">
                        24h Volume
                      </div>
                      <div class="text-muted" id="volume-24h">
                        Loading...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span class="bg-yellow text-white avatar">
                        <i class="ti ti-mood-smile"></i>
                      </span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">
                        Fear & Greed
                      </div>
                      <div class="text-muted" id="fear-greed">
                        Loading...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span class="bg-purple text-white avatar">
                        <i class="ti ti-arrows-exchange"></i>
                      </span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">
                        Altseason
                      </div>
                      <div class="text-muted" id="altseason">
                        Loading...
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Market Tickers Table -->
          <div class="card" id="tickers-card">
            <div class="card-header">
              <h3 class="card-title">Market Tickers</h3>
              <div class="card-actions">
                <button class="btn btn-primary btn-sm" onclick="loadTickersData()">
                  <i class="ti ti-refresh me-1"></i>
                  Refresh
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-vcenter card-table" id="tickers-table">
                <thead>
                  <tr>
                    <th>Coin</th>
                    <th>Price</th>
                    <th>24h %</th>
                    <th>OI</th>
                    <th>Funding</th>
                  </tr>
                </thead>
                <tbody id="tickers-tbody">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                      <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                      Loading tickers...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <footer class="footer footer-transparent d-print-none">
        <div class="container-xl">
          <div class="row text-center align-items-center flex-row-reverse">
            <div class="col-12 col-lg-auto mt-3 mt-lg-0">
              <ul class="list-inline list-inline-dots mb-0">
                <li class="list-inline-item">
                  Copyright &copy; 2024
                  <a href="." class="link-secondary">OmniBoard</a>.
                  All rights reserved.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  
  <!-- Tabler Core JS -->
  <script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js" defer></script>
  
  <!-- OmniBoard Scripts -->
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/components.js"></script>
  
  <script>
  // Market Overview Page Logic
  class MarketOverviewPage {
    constructor() {
      this.refreshIntervals = {
        overview: null,
        tickers: null
      };
      this.init();
    }

    init() {
      this.loadMarketData();
      this.loadTickersData();
      this.startAutoRefresh();
    }

    // Загрузить данные обзора рынка
    async loadMarketData() {
      try {
        const data = await window.omniboardAPI.getMarketOverview();
        this.updateKPICards(data);
      } catch (error) {
        console.error('Failed to load market overview:', error);
        this.showError('Failed to load market overview data');
      }
    }

    // Загрузить данные тикеров
    async loadTickersData() {
      try {
        const data = await window.omniboardAPI.getMarketTickers();
        this.updateTickersTable(data);
      } catch (error) {
        console.error('Failed to load tickers:', error);
        this.showError('Failed to load tickers data');
      }
    }

    // Обновить KPI карточки
    updateKPICards(data) {
      const marketCapEl = document.getElementById('market-cap');
      const volume24hEl = document.getElementById('volume-24h');
      const fearGreedEl = document.getElementById('fear-greed');
      const altseasonEl = document.getElementById('altseason');

      if (marketCapEl) marketCapEl.textContent = window.omniboardComponents.formatCurrency(data.market_cap);
      if (volume24hEl) volume24hEl.textContent = window.omniboardComponents.formatCurrency(data.volume_24h);
      if (fearGreedEl) fearGreedEl.textContent = data.fear_greed + '/100';
      if (altseasonEl) altseasonEl.textContent = data.altseason + '%';
    }

    // Обновить таблицу тикеров
    updateTickersTable(data) {
      const tbody = document.getElementById('tickers-tbody');
      if (!tbody) return;

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No ticker data available
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(ticker => `
        <tr>
          <td>
            <div class="d-flex align-items-center">
              <span class="avatar avatar-xs me-2">${ticker.symbol}</span>
              <strong>${ticker.symbol}</strong>
            </div>
          </td>
          <td>$${ticker.price.toLocaleString()}</td>
          <td>${window.omniboardComponents.createPriceBadge(ticker.change_24h)}</td>
          <td>$${window.omniboardComponents.formatNumber(ticker.oi)}</td>
          <td>${(ticker.funding * 100).toFixed(3)}%</td>
        </tr>
      `).join('');
    }

    // Начать автообновление
    startAutoRefresh() {
      const config = window.OMNIBOARD_CONFIG;
      
      // Обновление обзора рынка каждые 60 секунд
      this.refreshIntervals.overview = setInterval(() => {
        this.loadMarketData();
      }, (config.REFRESH_INTERVALS.MARKET_OVERVIEW || 60) * 1000);

      // Обновление тикеров каждые 30 секунд
      this.refreshIntervals.tickers = setInterval(() => {
        this.loadTickersData();
      }, (config.REFRESH_INTERVALS.TICKERS || 30) * 1000);
    }

    // Остановить автообновление
    stopAutoRefresh() {
      Object.values(this.refreshIntervals).forEach(interval => {
        if (interval) clearInterval(interval);
      });
    }

    // Показать ошибку
    showError(message) {
      window.omniboardComponents.showAlert(message, 'danger');
    }
  }

  // Глобальные функции для кнопок
  function loadMarketData() {
    if (window.marketOverviewPage) {
      window.marketOverviewPage.loadMarketData();
    }
  }

  function loadTickersData() {
    if (window.marketOverviewPage) {
      window.marketOverviewPage.loadTickersData();
    }
  }

  // Инициализация страницы
  document.addEventListener('DOMContentLoaded', function() {
    window.marketOverviewPage = new MarketOverviewPage();
  });

  // Очистка при уходе со страницы
  window.addEventListener('beforeunload', function() {
    if (window.marketOverviewPage) {
      window.marketOverviewPage.stopAutoRefresh();
    }
  });

  // Theme Toggle Functionality
  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;
    
    // Check saved theme or default to dark
    const savedTheme = localStorage.getItem('theme') || 'dark';
    body.className = `theme-${savedTheme}`;
    updateThemeIcon(savedTheme);
    
    themeToggle.addEventListener('click', function() {
      const currentTheme = body.classList.contains('theme-dark') ? 'dark' : 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.className = `theme-${newTheme}`;
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    });
  }
  
  function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('theme-icon');
    if (themeIcon) {
      themeIcon.className = theme === 'dark' ? 'ti ti-moon' : 'ti ti-sun';
    }
  }
  
  // Initialize theme toggle
  document.addEventListener('DOMContentLoaded', function() {
    initThemeToggle();
  });
  </script>
</body>
</html>
